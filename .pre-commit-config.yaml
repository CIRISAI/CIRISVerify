# Pre-commit hooks for CIRISVerify
# Install: pip install pre-commit && pre-commit install

repos:
  # Standard pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-toml
      - id: check-merge-conflict
      - id: check-added-large-files
        args: ['--maxkb=1000']

  # Local hooks for Rust
  - repo: local
    hooks:
      # Ensure Cargo.lock is up to date with workspace versions
      - id: cargo-lock-check
        name: Check Cargo.lock is current
        entry: bash -c 'cargo update -w --locked 2>/dev/null || (echo "ERROR: Cargo.lock is out of date. Run: cargo update -w" && exit 1)'
        language: system
        pass_filenames: false
        files: 'Cargo\.toml$'

      # Check formatting
      - id: cargo-fmt
        name: Rust format check
        entry: cargo fmt --all -- --check
        language: system
        pass_filenames: false
        types: [rust]

      # Run clippy
      - id: cargo-clippy
        name: Rust clippy
        entry: cargo clippy --all-targets --all-features -- -D warnings
        language: system
        pass_filenames: false
        types: [rust]

      # Check version consistency across files
      - id: version-consistency
        name: Check version consistency
        entry: bash -c '
          CARGO_VER=$(grep "^version = " Cargo.toml | head -1 | cut -d\" -f2)
          PYPROJECT_VER=$(grep "^version = " bindings/python/pyproject.toml | cut -d\" -f2)
          INIT_VER=$(grep "__version__" bindings/python/ciris_verify/__init__.py | cut -d\" -f2)
          if [ "$CARGO_VER" != "$PYPROJECT_VER" ] || [ "$CARGO_VER" != "$INIT_VER" ]; then
            echo "ERROR: Version mismatch!"
            echo "  Cargo.toml: $CARGO_VER"
            echo "  pyproject.toml: $PYPROJECT_VER"
            echo "  __init__.py: $INIT_VER"
            exit 1
          fi
          echo "Version consistent: $CARGO_VER"
        '
        language: system
        pass_filenames: false
        files: '(Cargo\.toml|pyproject\.toml|__init__\.py)$'
