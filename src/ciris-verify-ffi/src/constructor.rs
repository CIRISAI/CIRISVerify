//! Early function integrity verification via platform constructors.
//!
//! This module runs before `main()` to verify that the FFI functions have not
//! been tampered with since build time. The result is stored in a global
//! `FunctionIntegrityStatus` that clients can query via `ciris_verify_get_status()`.
//!
//! ## Platform Mechanisms
//!
//! - **Linux/Android**: `.init_array` section with priority 101
//! - **macOS/iOS**: `#[ctor::ctor]` attribute
//! - **Windows**: `DllMain` with `DLL_PROCESS_ATTACH`
//!
//! ## Fail-Secure Degradation
//!
//! Per threat model Section 7, all failures degrade to MORE restrictive modes.
//! The constructor sets the status; the client decides the action.
//!
//! | Status | Client Action |
//! |--------|---------------|
//! | Verified | Normal operation |
//! | Unavailable | Warn user, may retry |
//! | SignatureInvalid | Refuse to operate |
//! | Tampered | Refuse to operate |
//! | NotFound | First release? Client decides |

// Placeholder code - constructors will be enabled in a future release
#![allow(dead_code)]

use std::sync::OnceLock;
use std::time::Duration;

use ciris_verify_core::registry::{RegistryClient, DEFAULT_REGISTRY_URL};
use ciris_verify_core::security::function_integrity::{
    verify_functions, verify_manifest_signature, FunctionIntegrityStatus, StewardPublicKey,
};

/// Global function integrity status, set by constructor, read by `ciris_verify_get_status()`.
pub static FUNCTION_INTEGRITY_STATUS: OnceLock<FunctionIntegrityStatus> = OnceLock::new();

/// Steward public key for manifest verification.
///
/// This key is embedded at compile time and used to verify function manifests.
/// To rotate the key, a new version of CIRISVerify must be released.
///
/// Key ID: ae021ac9876cfa67f027d849e53ac088a2be5003c22db9297d9bd3471430dae1
/// Fetched from: https://api.registry.ciris-services-1.ai/v1/steward-key
static STEWARD_ED25519_PUBKEY: [u8; 32] = [
    0x1d, 0x9e, 0x82, 0xf6, 0x9f, 0x31, 0xaf, 0x62, 0xfd, 0xbf, 0xa6, 0x19,
    0x60, 0x96, 0x8a, 0x40, 0xbd, 0x4f, 0xf3, 0x50, 0x34, 0x48, 0x47, 0x36,
    0xce, 0xad, 0x0c, 0x38, 0x11, 0x72, 0x3e, 0x44,
];

/// ML-DSA-65 public key (1952 bytes)
/// Fingerprint: sha256:3d03615ef95090603c676507e7672b1ff19fa6e20e8b1b49bf95183e8eb120fc
#[rustfmt::skip]
static STEWARD_MLDSA65_PUBKEY: [u8; 1952] = [
    0x6b, 0xde, 0xc1, 0xe1, 0xdb, 0xc9, 0x3e, 0x7c, 0x12, 0xb8, 0x09, 0x8b, 0x87, 0x67, 0xe1, 0x64,
    0x4f, 0x26, 0x81, 0x66, 0x91, 0xee, 0x55, 0xba, 0x67, 0x34, 0x14, 0xcc, 0x03, 0xf1, 0xa1, 0xa3,
    0x85, 0x62, 0x5a, 0xe2, 0x00, 0xfb, 0xc8, 0x46, 0xa8, 0xe4, 0xb5, 0xee, 0xb8, 0xbd, 0x79, 0xe3,
    0x05, 0x21, 0xa2, 0x05, 0x2e, 0x31, 0xde, 0x6d, 0xfb, 0x51, 0xa1, 0x1b, 0x45, 0x92, 0xa8, 0x6d,
    0x35, 0x0e, 0x38, 0xc7, 0xb6, 0x5e, 0x68, 0xb3, 0xd7, 0x08, 0x7d, 0xc3, 0x48, 0xcb, 0xbb, 0xe4,
    0xaa, 0xb8, 0x5b, 0x45, 0x4e, 0xd1, 0x99, 0x47, 0xa2, 0x1b, 0x2d, 0x8f, 0xfc, 0x25, 0x60, 0x24,
    0x1c, 0x38, 0x1e, 0xd9, 0xd1, 0x6e, 0x54, 0x38, 0x29, 0x62, 0x5c, 0x6e, 0xdb, 0xee, 0xbb, 0x46,
    0xa4, 0x1e, 0x85, 0xcd, 0x91, 0x07, 0xc2, 0x65, 0x9b, 0xf3, 0x5f, 0xd0, 0xee, 0x84, 0x20, 0x0a,
    0xff, 0xb7, 0x8c, 0xc3, 0x83, 0x4b, 0x3b, 0xa5, 0xb2, 0x7a, 0x23, 0xf6, 0x3b, 0xb7, 0x28, 0x43,
    0x76, 0x4f, 0x57, 0xff, 0x4f, 0x08, 0xb1, 0x4b, 0xd3, 0x97, 0xc2, 0x69, 0x09, 0x96, 0x17, 0x59,
    0x25, 0xe5, 0xa9, 0x81, 0x8d, 0xb4, 0xaf, 0xad, 0x9e, 0xde, 0xe7, 0xf6, 0x39, 0x78, 0x5c, 0x90,
    0xe8, 0x8f, 0x5b, 0x09, 0xf0, 0x4f, 0x35, 0x70, 0x91, 0x41, 0x53, 0x3a, 0x16, 0x54, 0x21, 0x8e,
    0x37, 0x5b, 0x5a, 0x8d, 0x59, 0xad, 0xca, 0x8d, 0xab, 0xe2, 0x7b, 0x5d, 0x18, 0x7e, 0x36, 0xb1,
    0x33, 0x58, 0xab, 0x9d, 0x80, 0xa3, 0x8d, 0xaf, 0xe1, 0xe5, 0xca, 0xe2, 0x71, 0x44, 0x70, 0x79,
    0x1e, 0x32, 0x5e, 0x5f, 0x72, 0xdf, 0xee, 0xf4, 0x6a, 0x98, 0x0c, 0x85, 0x48, 0x24, 0xb2, 0x05,
    0xae, 0x55, 0x1b, 0x77, 0x5a, 0xce, 0xac, 0x40, 0xcf, 0x81, 0xae, 0xf9, 0x11, 0x8b, 0x1c, 0x43,
    0x68, 0x08, 0x2b, 0x5b, 0x44, 0xa4, 0xc3, 0x5f, 0xb0, 0x15, 0xce, 0x7e, 0xb7, 0x25, 0xc4, 0x5d,
    0xf3, 0xb5, 0xc1, 0x8d, 0x9e, 0xe0, 0x55, 0xfc, 0x3a, 0xc3, 0xad, 0xc9, 0x95, 0xd1, 0x43, 0x04,
    0xb5, 0xa2, 0x1c, 0xbb, 0xb3, 0x72, 0xa6, 0xb4, 0x12, 0x26, 0x93, 0x64, 0x9d, 0xa3, 0x16, 0x87,
    0x33, 0x77, 0x4a, 0xec, 0xc8, 0x06, 0xa3, 0x84, 0xe2, 0x1e, 0x7e, 0x24, 0xd4, 0x59, 0xa6, 0xa8,
    0xa2, 0x7c, 0xab, 0x46, 0x35, 0x96, 0xef, 0x4c, 0xa0, 0x1c, 0xcd, 0x2d, 0x87, 0x7c, 0x84, 0x9a,
    0x37, 0xf0, 0x28, 0x10, 0xeb, 0x8b, 0xd5, 0x57, 0x9e, 0x4a, 0x04, 0x10, 0xf9, 0x16, 0x16, 0xaa,
    0xd1, 0x7d, 0x3b, 0x44, 0xfa, 0x07, 0xa9, 0x27, 0x5f, 0x88, 0x72, 0x8c, 0x33, 0x4b, 0xfd, 0xbd,
    0x78, 0x7a, 0xd4, 0xfb, 0xf6, 0xfa, 0xa8, 0x0e, 0xb9, 0xbc, 0x72, 0xa3, 0x4e, 0xb5, 0x9d, 0x0e,
    0xb1, 0xae, 0x24, 0x07, 0xb7, 0xed, 0xa3, 0x92, 0x93, 0x3e, 0x6e, 0x7c, 0x16, 0x93, 0x03, 0x5b,
    0x83, 0xc1, 0xfd, 0x73, 0xfb, 0x47, 0xb6, 0xb5, 0x03, 0xfb, 0xaa, 0xd1, 0xb7, 0xe9, 0x26, 0xa8,
    0x1f, 0xed, 0xc4, 0xda, 0xd7, 0xf8, 0xc8, 0xa0, 0x32, 0x8c, 0x35, 0x45, 0xa8, 0xb7, 0xdc, 0xb7,
    0x87, 0xf7, 0xa2, 0xca, 0x37, 0xd8, 0x90, 0x6a, 0xda, 0xf2, 0x5d, 0x7c, 0x26, 0xa1, 0x4b, 0xb1,
    0x3d, 0x11, 0x56, 0xf9, 0x40, 0xf2, 0x5c, 0x31, 0x79, 0x8d, 0xf4, 0xaa, 0x46, 0xf2, 0xfc, 0x66,
    0xcd, 0x4e, 0x41, 0x47, 0xb5, 0xe7, 0xe7, 0xb3, 0x25, 0xaf, 0x39, 0xb2, 0x30, 0x3d, 0x77, 0x37,
    0xfb, 0x0f, 0x5e, 0x0b, 0xaa, 0x7a, 0xde, 0xcb, 0x2f, 0xf6, 0x41, 0x4c, 0xb6, 0x97, 0x52, 0xf9,
    0x50, 0x81, 0xe1, 0x84, 0x1a, 0x91, 0x5d, 0xac, 0xf5, 0x8c, 0x04, 0x6f, 0xbd, 0x7f, 0xae, 0x2e,
    0x77, 0xfc, 0xe2, 0xdc, 0x41, 0x6a, 0x23, 0x05, 0x36, 0x05, 0xc9, 0x62, 0xbd, 0x91, 0xe9, 0x00,
    0x36, 0xfa, 0xc6, 0x25, 0x3e, 0x37, 0x8a, 0xfa, 0x39, 0x0b, 0xbc, 0xd7, 0x3d, 0xc5, 0xbe, 0x4e,
    0x9b, 0xf9, 0x8c, 0x5f, 0x0b, 0x37, 0xc8, 0x24, 0x20, 0xb6, 0x4f, 0x15, 0x86, 0xbc, 0x10, 0x5e,
    0xf0, 0x9d, 0x4c, 0xf4, 0xb2, 0xb9, 0x90, 0x04, 0xd5, 0x76, 0x06, 0x6e, 0x75, 0x35, 0x40, 0x9c,
    0xaf, 0x7d, 0x18, 0x7b, 0x2f, 0x52, 0xa8, 0x5b, 0x99, 0xf8, 0x29, 0x5b, 0xc2, 0x07, 0x1a, 0x9e,
    0x10, 0x05, 0x92, 0xfe, 0x9f, 0x2e, 0x63, 0x99, 0xa2, 0xf8, 0xa7, 0x28, 0x07, 0x7d, 0x3e, 0x85,
    0xea, 0xd5, 0x6a, 0x65, 0xb5, 0x3b, 0x49, 0x71, 0x72, 0x1c, 0x40, 0x94, 0xe4, 0xe4, 0x3d, 0x4c,
    0x92, 0xa6, 0x56, 0x66, 0xd6, 0x77, 0xf7, 0x04, 0xd9, 0x93, 0x4b, 0x5c, 0xea, 0xc1, 0x98, 0xb9,
    0xac, 0x8d, 0x1a, 0x86, 0x16, 0xd5, 0x56, 0x65, 0x22, 0xee, 0xd9, 0xa7, 0xfa, 0x85, 0x03, 0x31,
    0x01, 0x86, 0xd6, 0x51, 0x8c, 0x95, 0x89, 0x62, 0x5f, 0x6a, 0x01, 0x74, 0xd8, 0x52, 0x6b, 0xe9,
    0x38, 0x15, 0x74, 0x91, 0x95, 0x7f, 0x31, 0x4c, 0xe4, 0xb4, 0xdd, 0x7c, 0xbf, 0xb2, 0x04, 0x8b,
    0x29, 0xe7, 0x16, 0x15, 0xb7, 0xf0, 0x10, 0x75, 0x3b, 0x50, 0xc2, 0x5d, 0xca, 0xc1, 0xf5, 0x1d,
    0x2d, 0x5e, 0x46, 0x34, 0xdc, 0x59, 0x3b, 0xc7, 0xe9, 0xa3, 0xaa, 0x75, 0xdb, 0xb2, 0x25, 0xb5,
    0x9a, 0xce, 0x38, 0x70, 0x99, 0x69, 0x74, 0xa9, 0x0c, 0x9f, 0xbe, 0x41, 0x68, 0xe6, 0xea, 0xf2,
    0xb8, 0x8c, 0x27, 0x31, 0xf6, 0xd4, 0xfb, 0x84, 0x7d, 0xc9, 0x81, 0x7d, 0x9a, 0xcc, 0x19, 0x1c,
    0xd1, 0xe0, 0x2b, 0xca, 0xdd, 0x9b, 0x7c, 0x25, 0x10, 0x27, 0xbd, 0x4a, 0xb5, 0x59, 0xe1, 0x80,
    0x66, 0x4c, 0x46, 0x6c, 0x7a, 0x05, 0xfc, 0xa9, 0x41, 0xbe, 0xb0, 0x0f, 0x61, 0x60, 0x7c, 0xe1,
    0x10, 0xa4, 0xfa, 0xce, 0x88, 0x40, 0xca, 0x96, 0x34, 0x1b, 0x9e, 0x87, 0x4b, 0xf6, 0x0e, 0x3e,
    0x32, 0x7d, 0xa8, 0x34, 0xd4, 0x5a, 0xf7, 0xe5, 0x63, 0x87, 0x17, 0x7e, 0xea, 0x57, 0x0c, 0xad,
    0xc3, 0x42, 0x33, 0x22, 0x87, 0xe5, 0xa6, 0xe3, 0x71, 0xb9, 0x1e, 0x2f, 0x16, 0xe9, 0x3e, 0xad,
    0x87, 0xea, 0xee, 0x83, 0xc2, 0x48, 0x5e, 0xf7, 0xce, 0xc9, 0x1b, 0x3c, 0x58, 0x09, 0x2a, 0xb5,
    0x63, 0x1f, 0x1d, 0xc8, 0xb1, 0x71, 0x8d, 0x2b, 0x4a, 0x38, 0x5c, 0x42, 0x29, 0xaf, 0x36, 0xe3,
    0x87, 0x70, 0xdb, 0xaa, 0xe1, 0xf3, 0xea, 0xca, 0x47, 0x3d, 0xcf, 0x5b, 0x47, 0x3f, 0xbb, 0x52,
    0x40, 0x94, 0x30, 0xc0, 0x9c, 0x3c, 0x06, 0x7b, 0x7a, 0x1b, 0x86, 0xee, 0x12, 0x82, 0xdb, 0x4a,
    0x37, 0x39, 0x58, 0x21, 0xf8, 0x03, 0x60, 0x5e, 0x7e, 0xfe, 0x38, 0x26, 0xfa, 0x42, 0x25, 0xae,
    0xb9, 0x3b, 0x6e, 0x64, 0x9b, 0xb7, 0x29, 0xf3, 0xc0, 0xbc, 0xda, 0xe3, 0xca, 0xaa, 0xe8, 0x58,
    0xbd, 0xf2, 0xca, 0x1d, 0x55, 0xfa, 0x49, 0xa4, 0x62, 0x4e, 0x08, 0xc1, 0x44, 0x3b, 0xa7, 0x0d,
    0x32, 0x54, 0xdb, 0x54, 0x53, 0x23, 0x33, 0xae, 0x60, 0x5d, 0xf4, 0x17, 0x80, 0xd0, 0xed, 0x48,
    0xb2, 0x0a, 0x5a, 0x6f, 0xae, 0x7e, 0xd2, 0xd0, 0xfa, 0x0a, 0xbc, 0x5f, 0xcc, 0xe3, 0xf7, 0x4d,
    0x24, 0xad, 0xed, 0x53, 0x56, 0x3f, 0x8c, 0x0b, 0x8c, 0xc1, 0x58, 0x87, 0xf5, 0x6c, 0x30, 0xea,
    0xe8, 0x65, 0xbc, 0xa2, 0xf1, 0x4d, 0x5a, 0x8c, 0x14, 0x27, 0x5b, 0x2c, 0xf9, 0x24, 0x8b, 0x7e,
    0x1b, 0xe6, 0x7d, 0x75, 0x7a, 0x99, 0xf8, 0x56, 0xe4, 0x85, 0xdb, 0x5c, 0x89, 0x1f, 0xbb, 0x1b,
    0xae, 0xb8, 0x5a, 0x81, 0x56, 0x8e, 0xcc, 0x2f, 0x57, 0x8f, 0x4e, 0xa9, 0x6b, 0x65, 0xc0, 0xec,
    0x1f, 0xa4, 0xdf, 0x2e, 0x20, 0xf1, 0x03, 0x90, 0x84, 0x0d, 0xa3, 0x41, 0xc2, 0xcf, 0xb6, 0xd0,
    0x87, 0xe3, 0xec, 0x75, 0xd1, 0x1f, 0x20, 0xb2, 0x00, 0x6a, 0x7a, 0x40, 0x43, 0x35, 0x22, 0x05,
    0x52, 0xd3, 0x70, 0xa5, 0x15, 0xc6, 0x43, 0xa0, 0x08, 0xe0, 0x89, 0x20, 0x5f, 0x16, 0x67, 0xc4,
    0x7b, 0xd6, 0xd0, 0xc5, 0x41, 0x17, 0x90, 0x0e, 0x7b, 0x70, 0x81, 0xd2, 0xbd, 0x45, 0x72, 0x00,
    0x32, 0xa9, 0x2e, 0xdf, 0x58, 0x83, 0xbf, 0x12, 0x15, 0xf7, 0x12, 0xd1, 0xd1, 0xc3, 0x08, 0x71,
    0x24, 0xff, 0x47, 0xb8, 0x3b, 0x62, 0xa4, 0x44, 0x72, 0xc9, 0x5f, 0x90, 0xca, 0xd3, 0x1a, 0x05,
    0xdd, 0x85, 0x04, 0x4f, 0xf6, 0x68, 0x21, 0xe4, 0x89, 0x20, 0x87, 0x76, 0x4b, 0x9f, 0xd6, 0x20,
    0x2e, 0x04, 0xa3, 0x17, 0xa3, 0xd5, 0xc2, 0xb9, 0xbf, 0x25, 0x32, 0x8c, 0xe7, 0x1f, 0xee, 0x9d,
    0xb7, 0x7c, 0x46, 0x33, 0xe5, 0xc0, 0x74, 0x7c, 0xc9, 0x40, 0xf3, 0x87, 0xd6, 0x3b, 0x9b, 0x74,
    0x9b, 0x7f, 0xbb, 0xd3, 0x0c, 0xc9, 0xf6, 0x54, 0xd1, 0xbe, 0x87, 0x91, 0x60, 0x42, 0x32, 0x2e,
    0x6c, 0xc1, 0xd1, 0x75, 0x79, 0x55, 0x3a, 0x2c, 0xb6, 0x99, 0x38, 0x3d, 0x99, 0xa9, 0x1f, 0xda,
    0xe8, 0x4e, 0x1e, 0x21, 0x27, 0x1e, 0x90, 0x72, 0x07, 0x3c, 0xa8, 0xf9, 0x66, 0xaf, 0x3f, 0xda,
    0xe9, 0x01, 0x3e, 0x84, 0xd7, 0x77, 0x02, 0x0a, 0x03, 0xe4, 0xd3, 0x6b, 0xee, 0x3e, 0xa6, 0xb5,
    0xcc, 0x59, 0x27, 0xc0, 0xc2, 0x96, 0x78, 0xf1, 0x01, 0xcc, 0xf0, 0x8c, 0x75, 0x45, 0x2d, 0xe5,
    0xda, 0xb8, 0xf9, 0xc6, 0x51, 0x92, 0x31, 0x21, 0x99, 0x87, 0x63, 0xc2, 0x86, 0x3e, 0xe7, 0x58,
    0xc4, 0x91, 0x85, 0x00, 0x6d, 0x32, 0x20, 0xf9, 0x98, 0x7d, 0x9a, 0xa0, 0x0e, 0x02, 0xb5, 0xbc,
    0x41, 0x9a, 0x69, 0x5d, 0xfe, 0x69, 0xa4, 0x85, 0x91, 0x50, 0xa5, 0xd4, 0x3c, 0x38, 0xf3, 0x28,
    0x0a, 0x07, 0xae, 0x10, 0x9b, 0x2d, 0x67, 0xfa, 0x33, 0x44, 0x33, 0x38, 0xe1, 0x8c, 0x8a, 0x7c,
    0xb7, 0x77, 0xf4, 0x2d, 0x0f, 0x3b, 0xb4, 0x02, 0x63, 0x33, 0xf5, 0x5e, 0x48, 0x99, 0xbd, 0x6f,
    0x34, 0xac, 0x63, 0x52, 0x27, 0xce, 0x93, 0x6f, 0x25, 0x7e, 0xeb, 0xbb, 0x7a, 0x79, 0xfe, 0x9f,
    0xfa, 0xf0, 0x31, 0xf4, 0xa4, 0x55, 0x6c, 0xca, 0x1a, 0x1c, 0x27, 0x55, 0xae, 0x2b, 0xe3, 0x60,
    0xaa, 0x49, 0x37, 0xee, 0x33, 0x8b, 0x17, 0x49, 0xab, 0x9f, 0x34, 0x19, 0x36, 0xb4, 0x01, 0x81,
    0x2a, 0xfb, 0xd4, 0x8f, 0x9a, 0x3e, 0x56, 0xf8, 0xbd, 0xee, 0x43, 0x82, 0x1a, 0x80, 0x19, 0x9c,
    0xac, 0x78, 0x2c, 0x4f, 0x33, 0xa6, 0xc6, 0xcd, 0x1e, 0xc9, 0x9a, 0xac, 0x09, 0x1c, 0x99, 0x7b,
    0x4f, 0xa7, 0x20, 0x63, 0x17, 0x4e, 0x78, 0xc7, 0x8d, 0x25, 0xde, 0xef, 0x9c, 0x66, 0x30, 0x48,
    0xa7, 0x39, 0xe5, 0x65, 0xae, 0xa3, 0xab, 0x9c, 0x84, 0x8c, 0x95, 0x5b, 0x20, 0x83, 0x8e, 0xc2,
    0x34, 0xea, 0xc7, 0x39, 0x19, 0xd4, 0x6f, 0xe8, 0x89, 0xae, 0x44, 0x08, 0x59, 0x06, 0xe2, 0x65,
    0xb9, 0x8b, 0xcc, 0xa4, 0x89, 0x01, 0x6b, 0xfc, 0x27, 0x81, 0xfc, 0xf4, 0x8b, 0xa1, 0x55, 0x67,
    0xb9, 0x60, 0x32, 0x5f, 0xc3, 0xf8, 0x54, 0x2a, 0xc2, 0x45, 0x64, 0x46, 0x92, 0x5b, 0x32, 0x26,
    0x10, 0x4c, 0x9a, 0x8a, 0xb1, 0xd6, 0xea, 0x06, 0x4b, 0x0e, 0x7a, 0x0c, 0xe8, 0x62, 0x62, 0xe8,
    0x4c, 0x88, 0x7b, 0x65, 0x6f, 0x19, 0x55, 0xd7, 0xb2, 0x77, 0xc7, 0xf2, 0x30, 0x7e, 0x55, 0xe6,
    0xd4, 0x7d, 0x18, 0x66, 0x9c, 0xd1, 0xd1, 0x4e, 0xab, 0x64, 0x74, 0x39, 0x84, 0x97, 0x58, 0x5a,
    0xe2, 0x8b, 0x45, 0xca, 0x4a, 0x10, 0x15, 0xb5, 0xf1, 0x0b, 0x4a, 0x1d, 0xd1, 0x12, 0x4e, 0x07,
    0xf6, 0x50, 0xcd, 0xa3, 0x3e, 0x80, 0x8b, 0x99, 0x5e, 0x82, 0xb0, 0x41, 0x83, 0xb4, 0x4c, 0x15,
    0x1f, 0x6f, 0x93, 0xdc, 0x24, 0xd7, 0xf7, 0x42, 0xb9, 0xa1, 0x76, 0xf8, 0xc8, 0xaa, 0x60, 0x5e,
    0x00, 0xfd, 0x2d, 0x53, 0x04, 0xe7, 0x58, 0x34, 0x85, 0x86, 0x00, 0x6a, 0x51, 0x53, 0x2f, 0x9e,
    0x4a, 0x74, 0xfe, 0x36, 0xde, 0xd8, 0xd5, 0x9d, 0xa1, 0x4d, 0x45, 0xd1, 0xbc, 0x6e, 0x71, 0x1c,
    0x4f, 0x55, 0xb8, 0x2e, 0xc4, 0x0f, 0x60, 0x88, 0xf7, 0xc5, 0xec, 0x98, 0x0a, 0x5b, 0x87, 0x42,
    0x9f, 0x4e, 0x5a, 0x20, 0x42, 0x4c, 0xef, 0x7d, 0xe4, 0x7e, 0xa5, 0x1e, 0xd2, 0x86, 0xfa, 0x75,
    0x89, 0xe4, 0xe5, 0x29, 0x4e, 0x92, 0x27, 0x3b, 0x0f, 0x75, 0x1c, 0x2f, 0xc0, 0xac, 0xa9, 0x8e,
    0x54, 0x79, 0x48, 0x6a, 0x9f, 0x78, 0x64, 0xfd, 0xc8, 0xa1, 0x15, 0x1f, 0x54, 0xc4, 0x83, 0x49,
    0x83, 0x9d, 0x96, 0xd0, 0xfa, 0xa4, 0xda, 0xd8, 0xb8, 0xfe, 0x6b, 0xef, 0xdf, 0x1f, 0xc8, 0xc1,
    0x08, 0xe3, 0x5f, 0x01, 0x0e, 0x95, 0x72, 0xd6, 0x6a, 0xc0, 0x59, 0xb3, 0x80, 0xb7, 0xc6, 0x54,
    0xbb, 0xfa, 0xab, 0x86, 0x5c, 0xc4, 0x91, 0x5d, 0xdd, 0x65, 0x1e, 0xad, 0xa3, 0xd9, 0x61, 0x20,
    0xe6, 0xe3, 0x59, 0xfb, 0xd1, 0xad, 0x78, 0xa9, 0x13, 0x08, 0x55, 0xb8, 0x5d, 0x48, 0x55, 0xc0,
    0xb3, 0xcb, 0x6a, 0xb2, 0xef, 0xb3, 0x10, 0x9b, 0x96, 0x41, 0x32, 0x2c, 0x88, 0x9b, 0x40, 0x59,
    0x3a, 0x8a, 0x20, 0x0b, 0xf9, 0x7a, 0xbd, 0x52, 0xa8, 0x57, 0xda, 0x64, 0x19, 0x33, 0x0a, 0x4d,
    0x78, 0x2a, 0x3c, 0xe4, 0x03, 0x31, 0x06, 0xc4, 0x9c, 0x19, 0x2e, 0xfc, 0xbb, 0xab, 0x11, 0x1c,
    0x75, 0x2f, 0x11, 0x82, 0x22, 0x31, 0x9f, 0xb6, 0xd2, 0x8e, 0xf7, 0x29, 0xdf, 0x78, 0xcc, 0x20,
    0x55, 0xd2, 0x45, 0xa1, 0xb3, 0x11, 0xcd, 0x87, 0x6e, 0x89, 0xa5, 0xd7, 0x7c, 0xb9, 0x37, 0xaa,
    0x5f, 0x8d, 0x7d, 0x58, 0x0a, 0x7e, 0xf2, 0xf7, 0x5d, 0x71, 0xbc, 0x2a, 0xaf, 0x64, 0xa8, 0x7f,
    0xca, 0xd8, 0x97, 0x53, 0x34, 0xb4, 0x59, 0xe5, 0xe7, 0x30, 0x80, 0x98, 0x83, 0x8f, 0xd8, 0x4e,
    0xa4, 0x9a, 0xac, 0x8d, 0x21, 0xa4, 0x32, 0x2f, 0xab, 0x8f, 0x91, 0xb9, 0xc2, 0x47, 0x00, 0x8b,
    0xa0, 0x28, 0x71, 0xc7, 0xc8, 0x73, 0x9f, 0x15, 0x03, 0x46, 0x81, 0x22, 0x30, 0x74, 0x29, 0x6b,
    0xa3, 0x59, 0x80, 0x06, 0xe1, 0xc2, 0xf6, 0x73, 0x50, 0x89, 0x23, 0x66, 0x10, 0x1c, 0xc3, 0xd4,
    0xc6, 0x3e, 0x96, 0x88, 0x37, 0x7a, 0x27, 0x5c, 0x7b, 0xfe, 0xa8, 0xa1, 0x58, 0xd9, 0x16, 0x72,
    0x4d, 0xf7, 0xc4, 0xef, 0x05, 0x0e, 0x7a, 0xf1, 0x22, 0xe8, 0x81, 0xf9, 0xb1, 0x12, 0xe0, 0xa0,
];

static STEWARD_PUBKEY: StewardPublicKey = StewardPublicKey {
    ed25519: &STEWARD_ED25519_PUBKEY,
    ml_dsa_65: &STEWARD_MLDSA65_PUBKEY,
};

/// Run early function integrity verification.
///
/// This function:
/// 1. Creates a minimal tokio runtime
/// 2. Fetches the function manifest from the registry
/// 3. Verifies the manifest signature
/// 4. Hashes each function in memory
/// 5. Stores the result in `FUNCTION_INTEGRITY_STATUS`
///
/// The function never fails - all errors result in a status being set.
fn early_verify() {
    use std::sync::Once;
    static INIT: Once = Once::new();

    INIT.call_once(|| {
        let status = run_verification();
        let _ = FUNCTION_INTEGRITY_STATUS.set(status);
    });
}

/// Perform the actual verification.
fn run_verification() -> FunctionIntegrityStatus {
    // Check if we have a valid steward key
    if *STEWARD_PUBKEY.ed25519 == [0u8; 32] || STEWARD_PUBKEY.ml_dsa_65.is_empty() {
        // Steward key not configured - skip verification
        // This is expected during development/testing
        return FunctionIntegrityStatus::Unavailable {
            reason: "steward_key_not_configured".to_string(),
        };
    }

    // Create minimal runtime for network fetch
    let rt = match tokio::runtime::Builder::new_current_thread()
        .enable_io()
        .enable_time()
        .build()
    {
        Ok(rt) => rt,
        Err(e) => {
            return FunctionIntegrityStatus::Unavailable {
                reason: format!("runtime:{}", e),
            }
        },
    };

    rt.block_on(async {
        let target = detect_target();
        let version = env!("CARGO_PKG_VERSION");

        // Fetch manifest (5 second timeout)
        let registry = match RegistryClient::new(DEFAULT_REGISTRY_URL, Duration::from_secs(5)) {
            Ok(r) => r,
            Err(e) => {
                return FunctionIntegrityStatus::Unavailable {
                    reason: format!("client:{}", e),
                }
            },
        };

        let manifest = match registry.get_function_manifest(version, target).await {
            Ok(m) => m,
            Err(ciris_verify_core::error::VerifyError::HttpsError { message }) => {
                // Could be network timeout, 404, etc.
                if message.contains("404") || message.contains("not found") {
                    return FunctionIntegrityStatus::NotFound;
                }
                return FunctionIntegrityStatus::Unavailable {
                    reason: format!("network:{}", message),
                };
            },
            Err(e) => {
                return FunctionIntegrityStatus::Unavailable {
                    reason: format!("fetch:{}", e),
                }
            },
        };

        // Verify signature
        match verify_manifest_signature(&manifest, &STEWARD_PUBKEY) {
            Ok(true) => {},
            Ok(false) => return FunctionIntegrityStatus::SignatureInvalid,
            Err(_) => return FunctionIntegrityStatus::SignatureInvalid,
        }

        // Verify function hashes
        let result = verify_functions(&manifest);
        if result.integrity_valid {
            FunctionIntegrityStatus::Verified
        } else {
            FunctionIntegrityStatus::Tampered
        }
    })
}

/// Detect the current target platform name.
///
/// Returns names that match the registry manifest naming convention.
/// - Desktop: Uses Rust target triples (e.g., `x86_64-unknown-linux-gnu`)
/// - Android: Uses Android ABI names (e.g., `android-arm64-v8a`)
/// - iOS: Uses Rust target triples (e.g., `aarch64-apple-ios`, `aarch64-apple-ios-sim`)
fn detect_target() -> &'static str {
    // Detect at compile time using cfg attributes

    // Desktop Linux
    #[cfg(all(target_arch = "x86_64", target_os = "linux", target_env = "gnu"))]
    return "x86_64-unknown-linux-gnu";

    #[cfg(all(target_arch = "aarch64", target_os = "linux", target_env = "gnu"))]
    return "aarch64-unknown-linux-gnu";

    // macOS
    #[cfg(all(target_arch = "x86_64", target_os = "macos"))]
    return "x86_64-apple-darwin";

    #[cfg(all(target_arch = "aarch64", target_os = "macos"))]
    return "aarch64-apple-darwin";

    // Windows
    #[cfg(all(target_arch = "x86_64", target_os = "windows", target_env = "msvc"))]
    return "x86_64-pc-windows-msvc";

    // Android - use ABI names to match registry manifest
    #[cfg(all(target_arch = "aarch64", target_os = "android"))]
    return "android-arm64-v8a";

    #[cfg(all(target_arch = "arm", target_os = "android"))]
    return "android-armeabi-v7a";

    #[cfg(all(target_arch = "x86_64", target_os = "android"))]
    return "android-x86_64";

    // iOS - use Rust target triples to match registry manifest and build.rs TARGET env
    #[cfg(all(target_arch = "aarch64", target_os = "ios", not(target_abi = "sim")))]
    return "aarch64-apple-ios";

    #[cfg(all(target_arch = "aarch64", target_os = "ios", target_abi = "sim"))]
    return "aarch64-apple-ios-sim";

    // Fallback for unknown targets
    #[cfg(not(any(
        all(target_arch = "x86_64", target_os = "linux", target_env = "gnu"),
        all(target_arch = "aarch64", target_os = "linux", target_env = "gnu"),
        all(target_arch = "x86_64", target_os = "macos"),
        all(target_arch = "aarch64", target_os = "macos"),
        all(target_arch = "x86_64", target_os = "windows", target_env = "msvc"),
        all(target_arch = "aarch64", target_os = "android"),
        all(target_arch = "arm", target_os = "android"),
        all(target_arch = "x86_64", target_os = "android"),
        all(target_arch = "aarch64", target_os = "ios", not(target_abi = "sim")),
        all(target_arch = "aarch64", target_os = "ios", target_abi = "sim"),
    )))]
    return "unknown";
}

/// Get the current function integrity status.
///
/// Returns the status set by the constructor, or `Pending` if not yet verified.
pub fn get_function_integrity_status() -> FunctionIntegrityStatus {
    FUNCTION_INTEGRITY_STATUS
        .get()
        .cloned()
        .unwrap_or(FunctionIntegrityStatus::Pending)
}

// =============================================================================
// Platform-Specific Constructors
// =============================================================================

// Linux/Android: .init_array constructor
#[cfg(any(target_os = "linux", target_os = "android"))]
#[cfg(not(any(test, debug_assertions)))]
mod ctor_impl {
    use super::early_verify;

    #[link_section = ".init_array"]
    #[used]
    static CTOR: extern "C" fn() = early_verify_ctor;

    extern "C" fn early_verify_ctor() {
        early_verify();
    }
}

// macOS/iOS: ctor crate
#[cfg(any(target_os = "macos", target_os = "ios"))]
#[cfg(not(any(test, debug_assertions)))]
#[ctor::ctor]
fn early_verify_ctor() {
    early_verify();
}

// Windows: DllMain
#[cfg(target_os = "windows")]
#[cfg(not(any(test, debug_assertions)))]
mod ctor_impl {
    use super::early_verify;
    use std::ffi::c_void;

    const DLL_PROCESS_ATTACH: u32 = 1;

    #[no_mangle]
    unsafe extern "system" fn DllMain(
        _hinst: *mut c_void,
        reason: u32,
        _reserved: *mut c_void,
    ) -> i32 {
        if reason == DLL_PROCESS_ATTACH {
            early_verify();
        }
        1 // TRUE - always succeed, status available via get_status()
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_function_integrity_status_display() {
        assert_eq!(FunctionIntegrityStatus::Verified.to_string(), "verified");
        assert_eq!(FunctionIntegrityStatus::Tampered.to_string(), "tampered");
        assert_eq!(
            FunctionIntegrityStatus::Unavailable {
                reason: "test".to_string()
            }
            .to_string(),
            "unavailable:test"
        );
        assert_eq!(
            FunctionIntegrityStatus::SignatureInvalid.to_string(),
            "signature_invalid"
        );
        assert_eq!(FunctionIntegrityStatus::NotFound.to_string(), "not_found");
        assert_eq!(FunctionIntegrityStatus::Pending.to_string(), "pending");
    }

    #[test]
    fn test_get_status_defaults_to_pending() {
        // In tests, constructor doesn't run (guarded by #[cfg(not(test))])
        // So we can test the default behavior
        // Note: OnceLock might already be set from other tests, so we check either case
        let status = get_function_integrity_status();
        // Either pending (not set) or some other status (from previous test runs)
        assert!(
            matches!(
                status,
                FunctionIntegrityStatus::Pending | FunctionIntegrityStatus::Unavailable { .. }
            ),
            "Unexpected status: {:?}",
            status
        );
    }

    #[test]
    fn test_detect_target() {
        let target = detect_target();
        assert!(!target.is_empty());
        // Should be a known platform name or "unknown"
        // Desktop: Rust triples (linux, darwin, windows)
        // Mobile: Platform names (android-*, ios-*)
        assert!(
            target.contains("linux")
                || target.contains("darwin")
                || target.contains("windows")
                || target.starts_with("android-")
                || target.contains("apple-ios")
                || target == "unknown",
            "Unexpected target: {}",
            target
        );
    }

    #[test]
    fn test_run_verification_with_real_keys() {
        // With real steward keys embedded, verification should proceed.
        // The result depends on network availability and whether a manifest exists:
        // - NotFound: No manifest published for this version yet
        // - Unavailable: Network timeout or error
        // - SignatureInvalid: Manifest exists but signature doesn't match
        // - Verified: Manifest exists and matches
        // - Tampered: Manifest exists, signature valid, but hashes don't match
        let status = run_verification();
        assert!(
            matches!(
                status,
                FunctionIntegrityStatus::Verified
                    | FunctionIntegrityStatus::NotFound
                    | FunctionIntegrityStatus::Unavailable { .. }
                    | FunctionIntegrityStatus::SignatureInvalid
                    | FunctionIntegrityStatus::Tampered
            ),
            "Unexpected status: {:?}",
            status
        );
    }
}
