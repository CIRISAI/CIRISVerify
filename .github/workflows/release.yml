name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  # ==========================================================================
  # Build Release - Native Platforms
  # ==========================================================================
  build-native:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (with TPM support)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: libciris_verify_ffi.so
            features: tpm

          # Linux ARM64 (cross-compile - native ARM64 runners have limited availability)
          # Note: TPM support disabled in cross-compile; use self-hosted ARM64 for TPM
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact: libciris_verify_ffi.so
            cross: true

          # macOS x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: libciris_verify_ffi.dylib

          # macOS ARM64 (Apple Silicon)
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: libciris_verify_ffi.dylib

          # Windows x86_64 (EXPERIMENTAL: native TPM via Platform Crypto Provider)
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: ciris_verify_ffi.dll
            features: tpm-windows

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: release-${{ matrix.target }}

      # Install TPM development libraries (Linux native only, not cross-compile)
      - name: Install TPM libs (Linux)
        if: runner.os == 'Linux' && !matrix.cross
        run: sudo apt-get update && sudo apt-get install -y libtss2-dev

      # Install cross for ARM64 cross-compilation
      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      # Build with cross (ARM64 Linux)
      - name: Build (cross)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }} -p ciris-verify-ffi

      # Build native
      - name: Build (native)
        if: ${{ !matrix.cross }}
        shell: bash
        run: |
          FEATURES="${{ matrix.features }}"
          if [ -n "$FEATURES" ]; then
            cargo build --release --target ${{ matrix.target }} -p ciris-verify-ffi --features "$FEATURES"
          else
            cargo build --release --target ${{ matrix.target }} -p ciris-verify-ffi
          fi

      # Strip binaries (Linux/macOS)
      - name: Strip binary
        if: runner.os != 'Windows'
        run: |
          if [ -f "target/${{ matrix.target }}/release/${{ matrix.artifact }}" ]; then
            strip "target/${{ matrix.target }}/release/${{ matrix.artifact }}" || true
          fi

      # Upload artifacts
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ciris-verify-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/${{ matrix.artifact }}
          if-no-files-found: error

  # ==========================================================================
  # Build Release - Android
  # ==========================================================================
  build-android:
    name: Build (Android ${{ matrix.abi }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-linux-android
            abi: arm64-v8a
          - target: armv7-linux-androideabi
            abi: armeabi-v7a
          - target: x86_64-linux-android
            abi: x86_64

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: release-android-${{ matrix.abi }}

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26b
          add-to-path: true

      - name: Set NDK environment
        run: |
          echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
          echo "NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Build for Android
        run: cargo ndk -t ${{ matrix.abi }} build --release -p ciris-verify-ffi --features android

      - name: Strip binary
        run: |
          ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
            target/${{ matrix.target }}/release/libciris_verify_ffi.so || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ciris-verify-android-${{ matrix.abi }}
          path: target/${{ matrix.target }}/release/libciris_verify_ffi.so
          if-no-files-found: error

  # ==========================================================================
  # Build Release - iOS
  # ==========================================================================
  build-ios:
    name: Build (iOS ${{ matrix.target }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-ios
            sdk: iphoneos
          - target: aarch64-apple-ios-sim
            sdk: iphonesimulator

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: release-ios-${{ matrix.target }}

      - name: Build for iOS
        run: cargo build --release --target ${{ matrix.target }} -p ciris-verify-ffi --features ios

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ciris-verify-ios-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/libciris_verify_ffi.a
          if-no-files-found: error

  # ==========================================================================
  # Create XCFramework (iOS)
  # ==========================================================================
  xcframework:
    name: Create XCFramework
    needs: build-ios
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download iOS artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ciris-verify-ios-*
          path: ios-libs
          merge-multiple: false

      - name: Create XCFramework
        run: |
          mkdir -p xcframework-build/ios xcframework-build/ios-sim

          # Copy libraries
          cp ios-libs/ciris-verify-ios-aarch64-apple-ios/libciris_verify_ffi.a xcframework-build/ios/
          cp ios-libs/ciris-verify-ios-aarch64-apple-ios-sim/libciris_verify_ffi.a xcframework-build/ios-sim/

          # Generate module map
          cat > xcframework-build/module.modulemap << 'EOF'
          module CirisVerify {
              header "ciris_verify.h"
              export *
          }
          EOF

          # Copy to both directories
          cp xcframework-build/module.modulemap xcframework-build/ios/
          cp xcframework-build/module.modulemap xcframework-build/ios-sim/

          # Create XCFramework
          xcodebuild -create-xcframework \
            -library xcframework-build/ios/libciris_verify_ffi.a \
            -library xcframework-build/ios-sim/libciris_verify_ffi.a \
            -output CirisVerify.xcframework

      - name: Upload XCFramework
        uses: actions/upload-artifact@v4
        with:
          name: CirisVerify.xcframework
          path: CirisVerify.xcframework
          if-no-files-found: error

  # ==========================================================================
  # Create Android AAR
  # ==========================================================================
  android-aar:
    name: Create Android AAR
    needs: build-android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ciris-verify-android-*
          path: android-libs
          merge-multiple: false

      - name: Create AAR structure
        run: |
          mkdir -p aar/jni/arm64-v8a aar/jni/armeabi-v7a aar/jni/x86_64

          # Copy native libraries
          cp android-libs/ciris-verify-android-arm64-v8a/libciris_verify_ffi.so aar/jni/arm64-v8a/
          cp android-libs/ciris-verify-android-armeabi-v7a/libciris_verify_ffi.so aar/jni/armeabi-v7a/
          cp android-libs/ciris-verify-android-x86_64/libciris_verify_ffi.so aar/jni/x86_64/

          # Create AndroidManifest.xml
          cat > aar/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="ai.ciris.verify">
              <uses-sdk android:minSdkVersion="21" android:targetSdkVersion="34" />
          </manifest>
          EOF

          # Create AAR
          cd aar && zip -r ../ciris-verify.aar . && cd ..

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: ciris-verify.aar
          path: ciris-verify.aar
          if-no-files-found: error

  # ==========================================================================
  # Generate C Header
  # ==========================================================================
  generate-header:
    name: Generate C Header
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Install cbindgen
        run: cargo install cbindgen

      - name: Generate header
        run: |
          cbindgen --config cbindgen.toml --crate ciris-verify-ffi --output ciris_verify.h || \
          cbindgen --crate ciris-verify-ffi --output ciris_verify.h --lang c

      - name: Upload header
        uses: actions/upload-artifact@v4
        with:
          name: ciris_verify.h
          path: ciris_verify.h
          if-no-files-found: warn

  # ==========================================================================
  # Build Manifest Tool (runs in parallel with other builds)
  # ==========================================================================
  build-manifest-tool:
    name: Build Manifest Tool
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: manifest-tool

      - name: Build manifest tool
        run: cargo build --release -p ciris-manifest-tool

      - name: Upload manifest tool
        uses: actions/upload-artifact@v4
        with:
          name: ciris-manifest-tool
          path: target/release/ciris-manifest-tool
          if-no-files-found: error

  # ==========================================================================
  # Create Release
  # ==========================================================================
  create-release:
    name: Create Release
    needs: [build-native, build-android, build-ios, xcframework, android-aar, generate-header, build-manifest-tool]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release

          # Copy native libraries
          for dir in artifacts/ciris-verify-x86_64-* artifacts/ciris-verify-aarch64-*; do
            if [ -d "$dir" ]; then
              target=$(basename "$dir" | sed 's/ciris-verify-//')
              mkdir -p "release/$target"
              cp -r "$dir"/* "release/$target/" || true
            fi
          done

          # Copy Android libraries
          for dir in artifacts/ciris-verify-android-*; do
            if [ -d "$dir" ]; then
              abi=$(basename "$dir" | sed 's/ciris-verify-android-//')
              mkdir -p "release/android/$abi"
              cp -r "$dir"/* "release/android/$abi/" || true
            fi
          done

          # Copy iOS libraries
          for dir in artifacts/ciris-verify-ios-*; do
            if [ -d "$dir" ]; then
              target=$(basename "$dir" | sed 's/ciris-verify-ios-//')
              mkdir -p "release/ios/$target"
              cp -r "$dir"/* "release/ios/$target/" || true
            fi
          done

          # Copy packages
          cp -r artifacts/CirisVerify.xcframework release/ || true
          cp artifacts/ciris-verify.aar/ciris-verify.aar release/ || true
          cp artifacts/ciris_verify.h/ciris_verify.h release/ || true

          # Create checksums
          cd release
          find . -type f \( -name "*.so" -o -name "*.dylib" -o -name "*.dll" -o -name "*.a" -o -name "*.aar" \) \
            -exec sha256sum {} \; > SHA256SUMS

          # Create archives
          cd ..
          tar -czvf ciris-verify-${{ github.ref_name }}-linux-x86_64.tar.gz -C release x86_64-unknown-linux-gnu || true
          tar -czvf ciris-verify-${{ github.ref_name }}-linux-arm64.tar.gz -C release aarch64-unknown-linux-gnu || true
          tar -czvf ciris-verify-${{ github.ref_name }}-macos-x86_64.tar.gz -C release x86_64-apple-darwin || true
          tar -czvf ciris-verify-${{ github.ref_name }}-macos-arm64.tar.gz -C release aarch64-apple-darwin || true
          tar -czvf ciris-verify-${{ github.ref_name }}-android.tar.gz -C release android || true
          tar -czvf ciris-verify-${{ github.ref_name }}-ios.tar.gz -C release ios CirisVerify.xcframework || true
          zip -r ciris-verify-${{ github.ref_name }}-windows-x86_64.zip release/x86_64-pc-windows-msvc || true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ciris-verify-*.tar.gz
            ciris-verify-*.zip
            release/ciris-verify.aar
            release/SHA256SUMS
            release/ciris_verify.h
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}

      # Generate manifest.json with all platform hashes for Portal/Registry
      - name: Generate distribution manifest
        run: |
          python3 -c "
          import json, hashlib, os, glob

          manifest = {
              'name': 'ciris-verify',
              'version': '${{ github.ref_name }}'.lstrip('v'),
              'built_at': '$(date -u +%Y-%m-%dT%H:%M:%SZ)',
              'release_url': 'https://github.com/CIRISAI/CIRISVerify/releases/tag/${{ github.ref_name }}',
              'platforms': {}
          }

          # Map target dirs to platform names
          platform_map = {
              'x86_64-unknown-linux-gnu': 'linux-x86_64',
              'aarch64-unknown-linux-gnu': 'linux-arm64',
              'x86_64-apple-darwin': 'darwin-x86_64',
              'aarch64-apple-darwin': 'darwin-arm64',
              'x86_64-pc-windows-msvc': 'windows-x86_64',
          }

          for target_dir, platform in platform_map.items():
              base = f'release/{target_dir}'
              if os.path.isdir(base):
                  manifest['platforms'][platform] = {}
                  for f in os.listdir(base):
                      fpath = os.path.join(base, f)
                      if os.path.isfile(fpath):
                          h = hashlib.sha256(open(fpath, 'rb').read()).hexdigest()
                          kind = 'dylib' if f.endswith('.dylib') else 'shared' if f.endswith('.so') else 'dll' if f.endswith('.dll') else 'static'
                          manifest['platforms'][platform][kind] = {
                              'file': f, 'sha256': h, 'size': os.path.getsize(fpath)
                          }

          # Android
          for abi in ['arm64-v8a', 'armeabi-v7a', 'x86_64']:
              sopath = f'release/android/{abi}/libciris_verify_ffi.so'
              if os.path.isfile(sopath):
                  h = hashlib.sha256(open(sopath, 'rb').read()).hexdigest()
                  manifest['platforms'][f'android-{abi}'] = {
                      'shared': {'file': 'libciris_verify_ffi.so', 'sha256': h, 'size': os.path.getsize(sopath)}
                  }

          # iOS
          for target in ['aarch64-apple-ios', 'aarch64-apple-ios-sim']:
              apath = f'release/ios/{target}/libciris_verify_ffi.a'
              pname = 'ios-arm64' if target == 'aarch64-apple-ios' else 'ios-sim-arm64'
              if os.path.isfile(apath):
                  h = hashlib.sha256(open(apath, 'rb').read()).hexdigest()
                  manifest['platforms'][pname] = {
                      'static': {'file': 'libciris_verify_ffi.a', 'sha256': h, 'size': os.path.getsize(apath)}
                  }

          print(json.dumps(manifest, indent=2))
          with open('release/manifest.json', 'w') as f:
              json.dump(manifest, f, indent=2)
          "

      - name: Upload manifest to release
        uses: softprops/action-gh-release@v1
        with:
          files: release/manifest.json

      # Generate and upload function manifests for runtime verification
      - name: Download manifest tool
        uses: actions/download-artifact@v4
        with:
          name: ciris-manifest-tool
          path: manifest-tool

      - name: Make manifest tool executable
        run: chmod +x manifest-tool/ciris-manifest-tool

      - name: Generate function manifests
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"

          mkdir -p function-manifests

          # Map artifact paths to targets
          declare -A TARGET_MAP=(
            ["release/x86_64-unknown-linux-gnu/libciris_verify_ffi.so"]="x86_64-unknown-linux-gnu"
            ["release/aarch64-unknown-linux-gnu/libciris_verify_ffi.so"]="aarch64-unknown-linux-gnu"
            ["release/x86_64-apple-darwin/libciris_verify_ffi.dylib"]="x86_64-apple-darwin"
            ["release/aarch64-apple-darwin/libciris_verify_ffi.dylib"]="aarch64-apple-darwin"
            ["release/x86_64-pc-windows-msvc/ciris_verify_ffi.dll"]="x86_64-pc-windows-msvc"
            ["release/android/arm64-v8a/libciris_verify_ffi.so"]="aarch64-linux-android"
            ["release/android/armeabi-v7a/libciris_verify_ffi.so"]="armv7-linux-androideabi"
            ["release/android/x86_64/libciris_verify_ffi.so"]="x86_64-linux-android"
          )

          for binary_path in "${!TARGET_MAP[@]}"; do
            if [ -f "$binary_path" ]; then
              target="${TARGET_MAP[$binary_path]}"
              echo "Generating function manifest for $target..."

              ./manifest-tool/ciris-manifest-tool generate \
                --binary "$binary_path" \
                --target "$target" \
                --version "$VERSION" \
                --output "function-manifests/${target}.json" \
                || echo "Warning: Failed to generate manifest for $target"
            fi
          done

          echo "Generated manifests:"
          ls -la function-manifests/

      - name: Upload function manifests to Registry
        if: ${{ !contains(github.ref_name, '-rc') && !contains(github.ref_name, '-beta') }}
        env:
          REGISTRY_ADMIN_TOKEN: ${{ secrets.REGISTRY_ADMIN_TOKEN }}
        run: |
          for manifest in function-manifests/*.json; do
            if [ -f "$manifest" ]; then
              target=$(basename "$manifest" .json)
              echo "Uploading function manifest for $target..."

              curl -sf -X POST \
                "https://api.registry.ciris-services-1.ai/v1/verify/function-manifest" \
                -H "Authorization: Bearer ${REGISTRY_ADMIN_TOKEN}" \
                -H "Content-Type: application/json" \
                -d @"$manifest" \
                && echo "  -> Success" \
                || echo "  -> Warning: Upload failed (endpoint may require signing)"
            fi
          done

      # Publish binary manifest to CIRISRegistry (so agents can verify binary integrity)
      - name: Register binary manifest with Registry
        if: ${{ !contains(github.ref_name, '-rc') && !contains(github.ref_name, '-beta') }}
        env:
          REGISTRY_ADMIN_TOKEN: ${{ secrets.REGISTRY_ADMIN_TOKEN }}
        run: |
          # Build the binary manifest payload for Registry API
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"  # Strip leading 'v'

          # Extract platform hashes from manifest.json
          python3 -c "
          import json, sys

          with open('release/manifest.json') as f:
              m = json.load(f)

          # Convert to Registry API format
          binaries = {}
          for platform, libs in m.get('platforms', {}).items():
              for lib_type, info in libs.items():
                  # Map platform names to Rust target triples
                  target_map = {
                      'linux-x86_64': 'x86_64-unknown-linux-gnu',
                      'linux-arm64': 'aarch64-unknown-linux-gnu',
                      'darwin-x86_64': 'x86_64-apple-darwin',
                      'darwin-arm64': 'aarch64-apple-darwin',
                      'windows-x86_64': 'x86_64-pc-windows-msvc',
                      'android-arm64-v8a': 'aarch64-linux-android',
                      'android-armeabi-v7a': 'armv7-linux-androideabi',
                      'android-x86_64': 'x86_64-linux-android',
                      'ios-arm64': 'aarch64-apple-ios',
                      'ios-sim-arm64': 'aarch64-apple-ios-sim',
                  }
                  target = target_map.get(platform, platform)
                  binaries[target] = f\"sha256:{info['sha256']}\"

          payload = {
              'version': '${VERSION}',
              'binaries': binaries,
              'generated_at': m.get('built_at', '')
          }

          print(json.dumps(payload, indent=2))
          with open('registry-payload.json', 'w') as f:
              json.dump(payload, f)
          "

          # Register with CIRISRegistry (primary endpoint)
          curl -sf -X POST "https://api.registry.ciris-services-1.ai/v1/verify/binary-manifest" \
            -H "Authorization: Bearer ${REGISTRY_ADMIN_TOKEN}" \
            -H "Content-Type: application/json" \
            -d @registry-payload.json \
            && echo "Binary manifest registered successfully" \
            || echo "Warning: Failed to register binary manifest (endpoint may not be deployed yet)"

  # ==========================================================================
  # Publish Python Wheels to PyPI
  # Uses the SAME FFI binaries that are registered in the manifest
  # ==========================================================================
  publish-pypi:
    name: Publish PyPI (${{ matrix.platform }})
    needs: [build-native, create-release]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: manylinux_x86_64
            artifact: ciris-verify-x86_64-unknown-linux-gnu
            lib_name: libciris_verify_ffi.so

          - os: ubuntu-latest
            platform: manylinux_aarch64
            artifact: ciris-verify-aarch64-unknown-linux-gnu
            lib_name: libciris_verify_ffi.so

          - os: macos-latest
            platform: macosx_x86_64
            artifact: ciris-verify-x86_64-apple-darwin
            lib_name: libciris_verify_ffi.dylib

          - os: macos-latest
            platform: macosx_arm64
            artifact: ciris-verify-aarch64-apple-darwin
            lib_name: libciris_verify_ffi.dylib

          - os: windows-latest
            platform: win_amd64
            artifact: ciris-verify-x86_64-pc-windows-msvc
            lib_name: ciris_verify_ffi.dll

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download FFI artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ffi-lib

      - name: Build wheel
        shell: bash
        run: |
          cd bindings/python

          # Install build dependencies
          pip install build wheel setuptools

          # Copy the CI-built FFI library into the package
          cp ../../ffi-lib/${{ matrix.lib_name }} ciris_verify/

          # Build the wheel
          python -m build --wheel

          # Rename wheel to platform-specific tag
          cd dist
          WHEEL=$(ls *.whl)
          # Extract version from wheel name
          VERSION=$(echo $WHEEL | sed -E 's/ciris_verify-([0-9.]+)-.*/\1/')

          # Determine Python tag and platform tag
          case "${{ matrix.platform }}" in
            manylinux_x86_64)
              NEW_NAME="ciris_verify-${VERSION}-py3-none-manylinux_2_17_x86_64.manylinux2014_x86_64.whl"
              ;;
            manylinux_aarch64)
              NEW_NAME="ciris_verify-${VERSION}-py3-none-manylinux_2_17_aarch64.manylinux2014_aarch64.whl"
              ;;
            macosx_x86_64)
              NEW_NAME="ciris_verify-${VERSION}-py3-none-macosx_10_12_x86_64.whl"
              ;;
            macosx_arm64)
              NEW_NAME="ciris_verify-${VERSION}-py3-none-macosx_11_0_arm64.whl"
              ;;
            win_amd64)
              NEW_NAME="ciris_verify-${VERSION}-py3-none-win_amd64.whl"
              ;;
          esac

          mv "$WHEEL" "$NEW_NAME"
          echo "Built wheel: $NEW_NAME"
          ls -la

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.platform }}
          path: bindings/python/dist/*.whl

  # ==========================================================================
  # Upload All Wheels to PyPI
  # ==========================================================================
  pypi-upload:
    name: Upload to PyPI
    needs: publish-pypi
    runs-on: ubuntu-latest
    if: ${{ !contains(github.ref_name, '-rc') && !contains(github.ref_name, '-beta') && !contains(github.ref_name, '-alpha') }}
    environment:
      name: pypi
      url: https://pypi.org/project/ciris-verify/
    permissions:
      id-token: write  # For trusted publishing
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheel-*
          path: wheels
          merge-multiple: true

      - name: Build source distribution
        run: |
          cd bindings/python
          pip install build
          python -m build --sdist
          cp dist/*.tar.gz ../../wheels/

      - name: List wheels
        run: ls -la wheels/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: wheels/
          skip-existing: true
