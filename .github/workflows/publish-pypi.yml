name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (build but do not publish)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read

jobs:
  # ==========================================================================
  # Build platform wheels (each contains the Rust binary for that platform)
  # ==========================================================================
  build-wheel:
    name: Wheel (${{ matrix.platform_tag }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (with TPM support)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: libciris_verify_ffi.so
            platform_tag: manylinux_2_17_x86_64
            features: tpm

          # Linux ARM64 (with TPM support)
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact: libciris_verify_ffi.so
            platform_tag: manylinux_2_17_aarch64
            cross: true
            features: tpm

          # macOS ARM64 (Apple Silicon) - uses Secure Enclave, not TPM
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: libciris_verify_ffi.dylib
            platform_tag: macosx_11_0_arm64
            features: ""

          # macOS x86_64 (cross-compile on ARM64 runner)
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: libciris_verify_ffi.dylib
            platform_tag: macosx_10_12_x86_64
            features: ""

          # Windows x86_64 (with TPM support)
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: ciris_verify_ffi.dll
            platform_tag: win_amd64
            features: tpm

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: pypi-${{ matrix.target }}

      # Install cross for ARM64 Linux
      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      # Install TPM development libraries (Linux)
      - name: Install TPM libs (Linux)
        if: runner.os == 'Linux' && !matrix.cross
        run: sudo apt-get update && sudo apt-get install -y libtss2-dev

      # Build Rust binary
      - name: Build Rust (cross)
        if: matrix.cross
        run: |
          FEATURES="${{ matrix.features }}"
          if [ -n "$FEATURES" ]; then
            cross build --release --target ${{ matrix.target }} -p ciris-verify-ffi --features "$FEATURES"
          else
            cross build --release --target ${{ matrix.target }} -p ciris-verify-ffi
          fi

      - name: Build Rust (native)
        if: ${{ !matrix.cross }}
        shell: bash
        run: |
          FEATURES="${{ matrix.features }}"
          if [ -n "$FEATURES" ]; then
            cargo build --release --target ${{ matrix.target }} -p ciris-verify-ffi --features "$FEATURES"
          else
            cargo build --release --target ${{ matrix.target }} -p ciris-verify-ffi
          fi

      # Strip binary (Linux/macOS)
      - name: Strip binary
        if: runner.os != 'Windows'
        run: |
          if [ -f "target/${{ matrix.target }}/release/${{ matrix.artifact }}" ]; then
            strip "target/${{ matrix.target }}/release/${{ matrix.artifact }}" || true
          fi

      # Copy binary into Python package
      - name: Copy binary into package
        shell: bash
        run: |
          cp "target/${{ matrix.target }}/release/${{ matrix.artifact }}" \
             "bindings/python/ciris_verify/${{ matrix.artifact }}"

      # Set up Python
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tools
        run: pip install build wheel setuptools

      # Build platform wheel
      - name: Build wheel
        working-directory: bindings/python
        shell: bash
        run: |
          # Build a wheel, then rename to correct platform tag
          python -m build --wheel --outdir dist/

          # Rename wheel to platform-specific tag
          cd dist
          for whl in *.whl; do
            # Replace py3-none-any with correct platform tag
            newname=$(echo "$whl" | sed "s/py3-none-any/py3-none-${{ matrix.platform_tag }}/")
            if [ "$whl" != "$newname" ]; then
              mv "$whl" "$newname"
            fi
          done

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.platform_tag }}
          path: bindings/python/dist/*.whl

  # ==========================================================================
  # Build source distribution (no binary, for pip install --no-binary)
  # ==========================================================================
  build-sdist:
    name: Source Distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tools
        run: pip install build

      - name: Build sdist
        working-directory: bindings/python
        run: python -m build --sdist --outdir dist/

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: bindings/python/dist/*.tar.gz

  # ==========================================================================
  # Publish to PyPI
  # ==========================================================================
  publish:
    name: Publish to PyPI
    needs: [build-wheel, build-sdist]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.dry_run == 'false'
    environment:
      name: pypi
      url: https://pypi.org/project/ciris-verify/

    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheel-*
          path: dist
          merge-multiple: true

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: List distribution files
        run: ls -lh dist/

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install twine
        run: pip install twine

      - name: Check distributions
        run: twine check dist/*

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload dist/*
